import React, { useState } from 'react';
import { Mail, Users, Plus, TrendingUp, Check, X, ExternalLink, Zap, ArrowRight, Flame } from 'lucide-react';

const DEMO_USER = { id: '1', email: 'demo@example.com', name: 'Demo User' };

const haptic = (type = 'light') => {
  if (window.navigator.vibrate) {
    const patterns = { light: [10], medium: [20], heavy: [30] };
    window.navigator.vibrate(patterns[type] || [10]);
  }
};

const PredictionApp = () => {
  const [currentView, setCurrentView] = useState('login');
  const [user, setUser] = useState<any>(null);
  const [groups, setGroups] = useState<any[]>([]);
  const [selectedGroup, setSelectedGroup] = useState<any>(null);
  const [predictions, setPredictions] = useState<any[]>([]);
  const [selectedPrediction, setSelectedPrediction] = useState<any>(null);

  const handleLogin = (email: string) => {
    haptic('medium');
    setUser(DEMO_USER);
    setCurrentView('groups');
  };

  const handleCreateGroup = (name: string) => {
    haptic('medium');
    const newGroup = {
      id: Date.now().toString(),
      name,
      inviteCode: Array.from({ length: 6 }, () => 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random() * 32)]).join(''),
      members: [DEMO_USER],
    };
    setGroups([...groups, newGroup]);
    setCurrentView('groups');
  };

  const handleCreatePrediction = (data: any) => {
    haptic('heavy');
    const newPred = {
      id: Date.now().toString(),
      groupId: selectedGroup.id,
      ...data,
      status: 'open',
      commitments: [{
        userId: DEMO_USER.id,
        userName: DEMO_USER.name,
        side: data.initialSide,
        amount: data.initialAmount,
      }],
    };
    setPredictions([...predictions, newPred]);
    setCurrentView('prediction');
    setSelectedPrediction(newPred);
  };

  const calculateSettlement = (pred: any, winningSide: string) => {
    const sideA = pred.commitments.filter((c: any) => c.side === 'a').reduce((sum: number, c: any) => sum + c.amount, 0);
    const sideB = pred.commitments.filter((c: any) => c.side === 'b').reduce((sum: number, c: any) => sum + c.amount, 0);
    const total = sideA + sideB;
    const sideTotal = winningSide === 'a' ? sideA : sideB;

    const winners = pred.commitments
      .filter((c: any) => c.side === winningSide)
      .map((c: any) => ({
        ...c,
        payout: (c.amount / sideTotal) * total,
        profit: ((c.amount / sideTotal) * total) - c.amount,
      }));

    const losers = pred.commitments
      .filter((c: any) => c.side !== winningSide)
      .map((c: any) => ({ ...c, loss: c.amount }));

    return { winners, losers };
  };

  const handleConfirmOutcome = (outcome: string) => {
    haptic('heavy');
    const settlement = calculateSettlement(selectedPrediction, outcome);
    setSelectedPrediction({ ...selectedPrediction, status: 'resolved', resolution: outcome, settlement });
    setCurrentView('settle');
  };

  if (currentView === 'login') {
    return <LoginView onLogin={handleLogin} />;
  }

  if (currentView === 'groups') {
    return (
      <GroupsView 
        groups={groups} 
        onSelectGroup={(g: any) => {
          setSelectedGroup(g);
          setCurrentView('prediction');
        }}
        onCreateGroup={() => setCurrentView('createGroup')}
      />
    );
  }

  if (currentView === 'createGroup') {
    return <CreateGroupView onCreate={handleCreateGroup} onBack={() => setCurrentView('groups')} />;
  }

  if (currentView === 'prediction') {
    return (
      <PredictionListView
        group={selectedGroup}
        predictions={predictions.filter((p) => p.groupId === selectedGroup?.id)}
        onSelectPrediction={(p: any) => setSelectedPrediction(p)}
        onCreatePrediction={() => setCurrentView('createPrediction')}
        onBack={() => setCurrentView('groups')}
      />
    );
  }

  if (currentView === 'createPrediction') {
    return <CreatePredictionView onCreate={handleCreatePrediction} onBack={() => setCurrentView('prediction')} />;
  }

  if (currentView === 'settle') {
    return <SettlementView prediction={selectedPrediction} onBack={() => setCurrentView('prediction')} />;
  }

  return <div>Loading...</div>;
};

const LoginView = ({ onLogin }: any) => {
  const [email, setEmail] = useState('');

  return (
    <div className="min-h-screen bg-black flex items-center justify-center p-4 relative overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-br from-purple-900/20 via-black to-cyan-900/20"></div>
      <div className="absolute top-0 left-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse"></div>
      <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse"></div>
      
      <div className="relative z-10 w-full max-w-md">
        <div className="text-center mb-8">
          <img src="https://i.imgur.com/S3VZl4y.png" alt="VYRE" className="w-32 h-32 mx-auto mb-6" style={{filter: 'drop-shadow(0 0 30px rgba(168, 85, 247, 0.4))'}} />
          <h1 className="text-6xl font-black mb-3 bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent">VYRE</h1>
          <p className="text-cyan-300/60 text-sm">Private predictions • Zero fees • Pure competition</p>
        </div>

        <div className="space-y-4 backdrop-blur-xl bg-white/5 p-6 rounded-3xl border border-white/10">
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full px-5 py-4 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white placeholder-gray-500"
            placeholder="Enter your email"
            style={{ fontSize: '16px' }}
          />
          <button
            onClick={() => onLogin(email)}
            className="w-full bg-gradient-to-r from-purple-600 to-cyan-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 shadow-lg shadow-purple-500/50"
            style={{ minHeight: '56px' }}
          >
            <Mail className="w-5 h-5" />
            Send Magic Link
            <ArrowRight className="w-5 h-5" />
          </button>
        </div>
      </div>
    </div>
  );
};

const GroupsView = ({ groups, onSelectGroup, onCreateGroup }: any) => {
  return (
    <div className="min-h-screen bg-black">
      <div className="sticky top-0 bg-black/95 backdrop-blur-xl border-b border-purple-500/20 px-4 py-6">
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-black text-white mb-1">Your Groups</h1>
            <p className="text-cyan-400/60 text-sm">Create • Join • Compete</p>
          </div>
          <button onClick={onCreateGroup} className="bg-gradient-to-r from-purple-600 to-cyan-600 text-white px-6 py-3 rounded-2xl flex items-center gap-2 font-bold shadow-lg shadow-purple-500/50">
            <Plus className="w-5 h-5" />
            New
          </button>
        </div>
      </div>

      <div className="p-4">
        {groups.length === 0 ? (
          <div className="backdrop-blur-xl bg-gradient-to-br from-purple-500/10 to-cyan-500/10 border border-purple-500/20 rounded-3xl p-12 text-center mt-8">
            <Users className="w-10 h-10 text-purple-400 mx-auto mb-4" />
            <p className="text-gray-400">No groups yet</p>
          </div>
        ) : (
          <div className="space-y-4 mt-4">
            {groups.map((g: any) => (
              <div key={g.id} onClick={() => onSelectGroup(g)} className="backdrop-blur-xl bg-gradient-to-r from-purple-500/10 to-cyan-500/10 border border-purple-500/20 p-6 rounded-3xl cursor-pointer">
                <h3 className="font-bold text-white text-xl mb-1">{g.name}</h3>
                <p className="text-cyan-400/60 text-sm flex items-center gap-2"><Zap className="w-3 h-3" />Code: {g.inviteCode}</p>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

const CreateGroupView = ({ onCreate, onBack }: any) => {
  const [name, setName] = useState('');

  return (
    <div className="min-h-screen bg-black">
      <div className="sticky top-0 bg-black/95 backdrop-blur-xl border-b border-purple-500/20 px-4 py-4">
        <button onClick={onBack} className="text-purple-400 font-bold flex items-center gap-2">
          <ArrowRight className="w-5 h-5 rotate-180" />
          Back
        </button>
      </div>
      <div className="p-6">
        <h2 className="text-3xl font-black text-white mb-2">Create Group</h2>
        <p className="text-cyan-400/60 mb-8">Name your prediction squad</p>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          className="w-full px-5 py-4 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white placeholder-gray-600 mb-6"
          placeholder="Weekend Warriors"
          style={{ fontSize: '16px' }}
        />
        <button onClick={() => name && onCreate(name)} disabled={!name} className="w-full bg-gradient-to-r from-purple-600 to-cyan-600 text-white py-4 rounded-2xl font-bold disabled:opacity-50 shadow-lg shadow-purple-500/50">
          Create Group
        </button>
      </div>
    </div>
  );
};

const PredictionListView = ({ group, predictions, onSelectPrediction, onCreatePrediction, onBack }: any) => {
  const calcStats = (commits: any[]) => {
    const sideA = commits.filter(c => c.side === 'a').reduce((s, c) => s + c.amount, 0);
    const sideB = commits.filter(c => c.side === 'b').reduce((s, c) => s + c.amount, 0);
    return { sideATotal: sideA, sideBTotal: sideB, totalPool: sideA + sideB };
  };

  return (
    <div className="min-h-screen bg-black">
      <div className="sticky top-0 bg-black/95 backdrop-blur-xl border-b border-purple-500/20 px-4 py-6">
        <button onClick={onBack} className="text-purple-400 font-bold mb-4 flex items-center gap-2">
          <ArrowRight className="w-5 h-5 rotate-180" />
          Back
        </button>
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-black text-white mb-1">{group.name}</h1>
            <p className="text-cyan-400/60 text-sm flex items-center gap-2"><Flame className="w-3 h-3" />Live Predictions</p>
          </div>
          <button onClick={onCreatePrediction} className="bg-gradient-to-r from-purple-600 to-cyan-600 text-white px-6 py-3 rounded-2xl flex items-center gap-2 font-bold shadow-lg shadow-purple-500/50">
            <Plus className="w-5 h-5" />
            New
          </button>
        </div>
      </div>

      <div className="p-4">
        {predictions.length === 0 ? (
          <div className="backdrop-blur-xl bg-gradient-to-br from-purple-500/10 to-cyan-500/10 border border-purple-500/20 rounded-3xl p-12 text-center mt-8">
            <TrendingUp className="w-12 h-12 text-purple-400 mx-auto mb-4" />
            <p className="text-gray-400">No predictions yet</p>
          </div>
        ) : (
          <div className="space-y-4 mt-4">
            {predictions.map((p: any) => {
              const stats = calcStats(p.commitments);
              return (
                <div key={p.id} onClick={() => onSelectPrediction(p)} className="backdrop-blur-xl bg-gradient-to-r from-purple-500/10 to-cyan-500/10 border border-purple-500/20 p-6 rounded-3xl cursor-pointer">
                  <h3 className="font-bold text-white text-lg mb-4">{p.title}</h3>
                  <div className="flex justify-between items-center">
                    <div className="text-center flex-1">
                      <div className="text-purple-400 text-sm mb-1">{p.sideALabel}</div>
                      <div className="text-2xl font-black text-white">${stats.sideATotal}</div>
                    </div>
                    <div className="text-cyan-400 text-xs">VS</div>
                    <div className="text-center flex-1">
                      <div className="text-cyan-400 text-sm mb-1">{p.sideBLabel}</div>
                      <div className="text-2xl font-black text-white">${stats.sideBTotal}</div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
};

const CreatePredictionView = ({ onCreate, onBack }: any) => {
  const [title, setTitle] = useState('');
  const [sideALabel, setSideALabel] = useState('Yes');
  const [sideBLabel, setSideBLabel] = useState('No');
  const [initialSide, setInitialSide] = useState('a');
  const [initialAmount, setInitialAmount] = useState('');

  return (
    <div className="min-h-screen bg-black">
      <div className="sticky top-0 bg-black/95 backdrop-blur-xl border-b border-purple-500/20 px-4 py-4">
        <button onClick={onBack} className="text-purple-400 font-bold flex items-center gap-2">
          <ArrowRight className="w-5 h-5 rotate-180" />
          Back
        </button>
      </div>
      <div className="p-6 space-y-6">
        <div>
          <h2 className="text-3xl font-black text-white mb-2">New Prediction</h2>
          <p className="text-cyan-400/60">Set the terms & make your call</p>
        </div>

        <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-5 py-4 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white placeholder-gray-600" placeholder="Chiefs win the Super Bowl" style={{ fontSize: '16px' }} />

        <div className="grid grid-cols-2 gap-4">
          <input type="text" value={sideALabel} onChange={(e) => setSideALabel(e.target.value)} className="w-full px-4 py-3 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white" style={{ fontSize: '16px' }} />
          <input type="text" value={sideBLabel} onChange={(e) => setSideBLabel(e.target.value)} className="w-full px-4 py-3 bg-black/40 border-2 border-cyan-500/30 rounded-2xl focus:border-cyan-500 focus:outline-none text-white" style={{ fontSize: '16px' }} />
        </div>

        <select value={initialSide} onChange={(e) => setInitialSide(e.target.value)} className="w-full px-5 py-4 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white" style={{ fontSize: '16px' }}>
          <option value="a">{sideALabel}</option>
          <option value="b">{sideBLabel}</option>
        </select>

        <div className="relative">
          <span className="absolute left-5 top-5 text-gray-500 text-xl">$</span>
          <input type="number" value={initialAmount} onChange={(e) => setInitialAmount(e.target.value)} className="w-full pl-12 pr-5 py-4 bg-black/40 border-2 border-purple-500/30 rounded-2xl focus:border-purple-500 focus:outline-none text-white placeholder-gray-600" placeholder="100" style={{ fontSize: '16px' }} />
        </div>

        <button onClick={() => title && initialAmount && onCreate({ title, sideALabel, sideBLabel, initialSide, initialAmount: parseFloat(initialAmount) })} disabled={!title || !initialAmount} className="w-full bg-gradient-to-r from-purple-600 to-cyan-600 text-white py-4 rounded-2xl font-bold disabled:opacity-50 shadow-lg shadow-purple-500/50">
          Create Prediction
        </button>
      </div>
    </div>
  );
};

const SettlementView = ({ prediction, onBack }: any) => {
  const { winners, losers } = prediction.settlement;

  return (
    <div className="min-h-screen bg-black pb-20">
      <div className="sticky top-0 bg-black/95 backdrop-blur-xl border-b border-purple-500/20 px-4 py-4">
        <button onClick={onBack} className="text-purple-400 font-bold flex items-center gap-2">
          <ArrowRight className="w-5 h-5 rotate-180" />
          Back
        </button>
      </div>

      <div className="p-4">
        <div className="backdrop-blur-xl bg-gradient-to-r from-green-500/10 to-cyan-500/10 border border-green-500/30 rounded-3xl p-6 mb-6 mt-4">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center">
              <Check className="w-6 h-6 text-green-400" />
            </div>
            <div>
              <h2 className="text-2xl font-black text-white">Resolved</h2>
              <p className="text-green-400/60 text-sm">Outcome confirmed</p>
            </div>
          </div>
          <p className="text-gray-300">{prediction.title}</p>
        </div>

        <div className="space-y-6">
          <div>
            <h3 className="font-black text-green-400 mb-4 flex items-center gap-2 text-lg">
              <Zap className="w-5 h-5" />
              Winners
            </h3>
            <div className="space-y-3">
              {winners.map((w: any, i: number) => (
                <div key={i} className="backdrop-blur-xl bg-gradient-to-r from-green-500/10 to-cyan-500/10 border border-green-500/30 rounded-3xl p-6">
                  <div className="flex justify-between items-center">
                    <span className="font-bold text-white">{w.userName}</span>
                    <span className="text-green-400 font-black text-2xl">+${w.profit.toFixed(2)}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h3 className="font-black text-red-400 mb-4 flex items-center gap-2 text-lg">
              <X className="w-5 h-5" />
              Losers
            </h3>
            <div className="space-y-3">
              {losers.map((l: any, i: number) => (
                <div key={i} className="backdrop-blur-xl bg-gradient-to-r from-red-500/10 to-pink-500/10 border border-red-500/30 rounded-3xl p-6">
                  <div className="flex justify-between items-center">
                    <span className="font-bold text-white">{l.userName}</span>
                    <span className="text-red-400 font-black text-2xl">-${l.loss}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PredictionApp;